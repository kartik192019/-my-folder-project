{% extends "base.html" %}
{% block title %}Scoring Details - {{ job_description.title or 'Untitled' }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>Scoring Details</h2>
            
            <!-- Job Description Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Job Description Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr>
                            <td><strong>Title:</strong></td>
                            <td>{{ job_description.title or 'Untitled' }}</td>
                        </tr>
                        <tr>
                            <td><strong>JD ID:</strong></td>
                            <td>{{ job_description.jd_id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Company ID:</strong></td>
                            <td>{{ job_description.company_id or 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>{{ job_description.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        <tr>
                            <td><strong>File:</strong></td>
                            <td>
                                {% if job_description.file_id %}
                                    <a href="{{ job_description.file_id }}" target="_blank" class="btn btn-sm btn-info">View File</a>
                                {% elif job_description.jd_file %}
                                    {{ job_description.jd_file }}
                                {% else %}
                                    Text Input
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Statistics -->
            {% if stats %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Scoring Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-primary">{{ stats.total_resumes or 0 }}</h3>
                                    <p>Total Resumes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-info">{{ "%.1f"|format(stats.avg_score or 0) }}</h3>
                                    <p>Average Score</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-success">{{ stats.to_interview or 0 }}</h3>
                                    <p>To Interview</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-danger">{{ stats.rejected or 0 }}</h3>
                                    <p>Rejected</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Scoring Results -->
            <div class="card">
                <div class="card-header">
                    <h5>Resume Scores</h5>
                </div>
                <div class="card-body">
                    {% if scoring_results %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Resume</th>
                                    <th>Criteria</th>
                                    <th>Final Score</th>
                                    <th>Recommendation</th>
                                    <th>Scored On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in scoring_results %}
                                <tr class="
                                    {% if result.recommendation == 'To be interviewed' %}table-success
                                    {% elif result.recommendation == 'Candidature rejected' %}table-danger
                                    {% else %}table-warning{% endif %}
                                ">
                                    <td>{{ result.resume_filename }}</td>
                                    <td>{{ result.criteria_name or 'N/A' }}</td>
                                    <td>
                                        <span class="badge badge-primary badge-lg">
                                            {{ "%.1f"|format(result.final_score) }}/10
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if result.recommendation == 'To be interviewed' %}badge-success
                                            {% elif result.recommendation == 'Candidature rejected' %}badge-danger
                                            {% else %}badge-warning{% endif %}
                                        ">
                                            {{ result.recommendation }}
                                        </span>
                                    </td>
                                    <td>{{ result.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info" 
                                                data-score-id="{{ result.score_id }}"
                                                data-filename="{{ result.resume_filename|e }}"
                                                data-parameter-scores="{{ result.parameter_scores|tojson|e }}"
                                                data-consideration="{{ result.consideration|e }}"
                                                data-final-score="{{ result.final_score }}"
                                                data-recommendation="{{ result.recommendation|e }}"
                                                onclick="showScoringModalFromData(this)">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <h5>No Scoring Results Found</h5>
                        <p>No resumes have been scored for this job description yet.</p>
                        <a href="/upload" class="btn btn-primary">Upload Resumes</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-3">
                <a href="/job_descriptions" class="btn btn-secondary">Back to Job Descriptions</a>
            </div>
        </div>
    </div>
</div>

<!-- Scoring Details Modal -->
<div class="modal fade" id="scoringModal" tabindex="-1" role="dialog" aria-labelledby="scoringModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scoringModalLabel">Scoring Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="scoringModalContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function showScoringModalFromData(button) {
    // Get data from button attributes
    const scoreId = button.getAttribute('data-score-id');
    const filename = button.getAttribute('data-filename');
    const parameterScoresStr = button.getAttribute('data-parameter-scores');
    const consideration = button.getAttribute('data-consideration');
    const finalScore = button.getAttribute('data-final-score');
    const recommendation = button.getAttribute('data-recommendation');
    
    // Parse parameter scores JSON safely
    let parameterScores = {};
    try {
        parameterScores = JSON.parse(parameterScoresStr);
    } catch (e) {
        console.error('Error parsing parameter scores:', e);
        parameterScores = {};
    }
    
    // Call the display function
    showScoringModal(scoreId, filename, parameterScores, consideration, finalScore, recommendation);
}

function showScoringModal(scoreId, filename, parameterScores, consideration, finalScore, recommendation) {
    const modalContent = document.getElementById('scoringModalContent');
    
    // Safely handle consideration text
    let safeConsideration = consideration || 'No consideration provided';
    // Replace newlines with <br> tags for HTML display and escape HTML
    safeConsideration = safeConsideration.replace(/\n/g, '<br>').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    let html = `
        <h6><strong>Resume:</strong> ${filename}</h6>
        <h6><strong>Final Score:</strong> <span class="badge badge-primary">${finalScore}/10</span></h6>
        <h6><strong>Recommendation:</strong> 
            <span class="badge ${recommendation === 'To be interviewed' ? 'badge-success' : 
                                 recommendation === 'Candidature rejected' ? 'badge-danger' : 'badge-warning'}">
                ${recommendation}
            </span>
        </h6>
        <hr>
        
        <h6>Parameter Scores:</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Score</th>
                        <th>Weightage</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (parameterScores && typeof parameterScores === 'object' && Object.keys(parameterScores).length > 0) {
        for (const [param, data] of Object.entries(parameterScores)) {
            const score = data && data.score !== undefined ? data.score : 'N/A';
            const weightage = data && data.weightage !== undefined ? data.weightage : 'N/A';
            const rating = data && data.rating !== undefined ? data.rating : 'N/A';
            
            html += `
                <tr>
                    <td>${param}</td>
                    <td>${score}</td>
                    <td>${weightage}${weightage !== 'N/A' ? '%' : ''}</td>
                    <td>${rating}</td>
                </tr>
            `;
        }
    } else {
        html += '<tr><td colspan="4">No parameter scores available</td></tr>';
    }
    
    html += `
                </tbody>
            </table>
        </div>
        
        <hr>
        <h6>Consideration:</h6>
        <div class="alert alert-light">
            ${safeConsideration}
        </div>
    `;
    
    modalContent.innerHTML = html;
    $('#scoringModal').modal('show');
}
</script>
{% endblock %}
